<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>

var map = L.map('map').setView([31.5,-7],6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

var geoLayer;
var colors = ["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c","#00441b","#002b13"];

function calculateBreaks(values, classCount){
    const min = Math.min(...values);
    const max = Math.max(...values);
    const interval = (max-min)/classCount;
    let breaks=[];
    for(let i=0;i<=classCount;i++){
        breaks.push(min+i*interval);
    }
    return breaks;
}

function getColor(value, breaks){
    for(let i=0;i<breaks.length-1;i++){
        if(value >= breaks[i] && value <= breaks[i+1]){
            return colors[i];
        }
    }
}

function loadLayer(){

 if(geoLayer){
   map.removeLayer(geoLayer);
 }

 var level = document.getElementById("level").value;
 var classCount = parseInt(document.getElementById("classes").value);

 Promise.all([
   fetch(level + ".json").then(res => res.json()),
   fetch(level + ".csv").then(res => res.text())
 ])
 .then(([geoData, csvData]) => {

   var table = Papa.parse(csvData,{header:true}).data;

   // تحويل CSV إلى قاموس
   var dataMap = {};
   table.forEach(row=>{
      dataMap[row.CODE] = parseFloat(row.pop_total);
   });

   // دمج القيم داخل geojson
   geoData.features.forEach(feature=>{
      var code = feature.properties.CODE;
      feature.properties.pop_total = dataMap[code] || 0;
   });

   var values = geoData.features.map(f=>f.properties.pop_total);
   var breaks = calculateBreaks(values,classCount);

   geoLayer = L.geoJson(geoData,{
      style:function(feature){
         return{
           fillColor:getColor(feature.properties.pop_total,breaks),
           weight:1,
           color:"#333",
           fillOpacity:0.7
         }
      },
      onEachFeature:function(feature,layer){
         layer.bindPopup(
           "<b>"+feature.properties.NAME+"</b><br>"+
           "السكان: "+feature.properties.pop_total
         );
      }
   }).addTo(map);

 });

}

loadLayer();

</script>
